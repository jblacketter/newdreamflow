{% extends 'base.html' %}

{% block title %}Edit Story: {{ story.title }}{% endblock %}

{% block extra_head %}
<style>
    .story-editor {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem;
    }
    
    .editor-header {
        margin-bottom: 2rem;
    }
    
    .editor-title {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 1rem;
    }
    
    .editor-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
    }
    
    .editor-section {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 0.75rem;
        padding: 1.5rem;
    }
    
    .section-title {
        font-size: 1.25rem;
        font-weight: 600;
        margin-bottom: 1rem;
        color: #374151;
    }
    
    .form-group {
        margin-bottom: 1.5rem;
    }
    
    .form-label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
        color: #374151;
    }
    
    .form-input {
        width: 100%;
        padding: 0.75rem;
        border: 2px solid #e5e7eb;
        border-radius: 0.5rem;
        font-size: 1rem;
    }
    
    .form-textarea {
        min-height: 100px;
        resize: vertical;
    }
    
    .story-things-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    
    .story-thing-item {
        display: flex;
        align-items: center;
        padding: 1rem;
        background: #f9fafb;
        border-radius: 0.5rem;
        margin-bottom: 0.75rem;
        cursor: move;
        transition: all 0.2s;
    }
    
    .story-thing-item:hover {
        background: #f3f4f6;
    }
    
    .story-thing-item.dragging {
        opacity: 0.5;
    }
    
    .drag-handle {
        margin-right: 1rem;
        color: #9ca3af;
    }
    
    .thing-info {
        flex: 1;
    }
    
    .thing-title {
        font-weight: 600;
        margin-bottom: 0.25rem;
    }
    
    .thing-excerpt {
        font-size: 0.875rem;
        color: #6b7280;
    }
    
    .thing-duration {
        margin: 0 1rem;
    }
    
    .duration-input {
        width: 60px;
        padding: 0.25rem;
        border: 1px solid #e5e7eb;
        border-radius: 0.25rem;
        text-align: center;
    }
    
    .remove-btn {
        padding: 0.5rem;
        background: #fee2e2;
        color: #dc2626;
        border: none;
        border-radius: 0.375rem;
        cursor: pointer;
        transition: background 0.2s;
    }
    
    .remove-btn:hover {
        background: #fecaca;
    }
    
    .available-things {
        max-height: 400px;
        overflow-y: auto;
        border: 1px solid #e5e7eb;
        border-radius: 0.5rem;
        padding: 0.5rem;
    }
    
    .available-thing {
        display: flex;
        align-items: center;
        padding: 0.75rem;
        background: #f9fafb;
        border-radius: 0.375rem;
        margin-bottom: 0.5rem;
        cursor: pointer;
    }
    
    .available-thing:hover {
        background: #f3f4f6;
    }
    
    .available-thing input[type="checkbox"] {
        margin-right: 0.75rem;
    }
    
    .action-buttons {
        display: flex;
        gap: 1rem;
        margin-top: 2rem;
    }
    
    .btn {
        padding: 0.75rem 1.5rem;
        border-radius: 0.5rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        border: none;
        font-size: 1rem;
    }
    
    .btn-primary {
        background: #818cf8;
        color: white;
    }
    
    .btn-primary:hover {
        background: #6366f1;
    }
    
    .btn-success {
        background: #10b981;
        color: white;
    }
    
    .btn-success:hover {
        background: #059669;
    }
    
    .btn-secondary {
        background: #f3f4f6;
        color: #374151;
    }
    
    .btn-secondary:hover {
        background: #e5e7eb;
    }
    
    @media (max-width: 768px) {
        .editor-grid {
            grid-template-columns: 1fr;
        }
    }
    
    @media (prefers-color-scheme: dark) {
        .editor-section {
            background: #1f2937;
            border-color: #374151;
        }
        
        .form-input {
            background: #111827;
            color: #f3f4f6;
            border-color: #374151;
        }
        
        .story-thing-item {
            background: #374151;
        }
        
        .story-thing-item:hover {
            background: #4b5563;
        }
        
        .available-things {
            background: #111827;
            border-color: #374151;
        }
        
        .available-thing {
            background: #374151;
        }
        
        .available-thing:hover {
            background: #4b5563;
        }
        
        .btn-secondary {
            background: #374151;
            color: #f3f4f6;
        }
        
        .btn-secondary:hover {
            background: #4b5563;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="story-editor">
    <div class="editor-header">
        <h1 class="editor-title">Edit Story</h1>
    </div>
    
    <form method="post" id="story-form">
        {% csrf_token %}
        
        <div class="editor-grid">
            <!-- Story Details Section -->
            <div class="editor-section">
                <h2 class="section-title">Story Details</h2>
                
                <div class="form-group">
                    <label for="title" class="form-label">Title</label>
                    <input type="text" id="title" name="title" value="{{ story.title }}" class="form-input" required>
                </div>
                
                <div class="form-group">
                    <label for="description" class="form-label">Description</label>
                    <textarea id="description" name="description" class="form-input form-textarea">{{ story.description }}</textarea>
                </div>
                
                <div class="form-group">
                    <label for="privacy_level" class="form-label">Privacy Level</label>
                    <select id="privacy_level" name="privacy_level" class="form-input">
                        <option value="private" {% if story.privacy_level == 'private' %}selected{% endif %}>Private</option>
                        <option value="specific_users" {% if story.privacy_level == 'specific_users' %}selected{% endif %}>Specific Users</option>
                        <option value="groups" {% if story.privacy_level == 'groups' %}selected{% endif %}>Groups</option>
                        <option value="community" {% if story.privacy_level == 'community' %}selected{% endif %}>Community</option>
                    </select>
                </div>
                
                <!-- Add Things Section -->
                <h3 class="section-title" style="margin-top: 2rem;">Add Things to Story</h3>
                <div class="available-things">
                    {% for thing in available_things %}
                    <label class="available-thing">
                        <input type="checkbox" name="new_things" value="{{ thing.pk }}">
                        <div>
                            <div style="font-weight: 600;">{{ thing.title|default:"Untitled" }}</div>
                            <div style="font-size: 0.875rem; color: #6b7280;">{{ thing.thing_date|date:"F j, Y" }}</div>
                        </div>
                    </label>
                    {% empty %}
                    <p style="text-align: center; color: #6b7280; padding: 1rem;">All your things are already in this story</p>
                    {% endfor %}
                </div>
                
                {% if available_things %}
                <button type="submit" name="add_things" value="1" class="btn btn-secondary" style="margin-top: 1rem; width: 100%;">Add Selected Things</button>
                {% endif %}
            </div>
            
            <!-- Story Sequence Section -->
            <div class="editor-section">
                <h2 class="section-title">Story Sequence ({{ story_things.count }} things)</h2>
                
                <ul class="story-things-list" id="sortable-list">
                    {% for story_thing in story_things %}
                    <li class="story-thing-item" data-id="{{ story_thing.pk }}">
                        <span class="drag-handle">☰</span>
                        <div class="thing-info">
                            <div class="thing-title">{{ story_thing.thing.title|default:"Untitled" }}</div>
                            <div class="thing-excerpt">{{ story_thing.thing.description|truncatewords:15 }}</div>
                        </div>
                        <div class="thing-duration">
                            <input type="number" class="duration-input" value="{{ story_thing.duration }}" min="1" max="60"> sec
                        </div>
                        <input type="hidden" name="thing_order" value="{{ story_thing.pk }}">
                        <button type="button" class="remove-btn" onclick="removeThing('{{ story_thing.pk }}')">×</button>
                    </li>
                    {% empty %}
                    <li style="text-align: center; padding: 2rem; color: #6b7280;">
                        No things in this story yet. Add some from the left panel.
                    </li>
                    {% endfor %}
                </ul>
                
                {% if story_things %}
                <button type="submit" name="reorder" value="1" class="btn btn-secondary" style="margin-top: 1rem; width: 100%;">Save Order & Timing</button>
                {% endif %}
            </div>
        </div>
        
        <div class="action-buttons">
            <button type="submit" class="btn btn-primary">Save Changes</button>
            <button type="submit" name="save_and_play" value="1" class="btn btn-success">Save & Play</button>
            <a href="{% url 'things:story_detail' pk=story.pk %}" class="btn btn-secondary" style="text-decoration: none;">Cancel</a>
        </div>
    </form>
</div>

<script>
// Drag and drop functionality
const sortableList = document.getElementById('sortable-list');
let draggedItem = null;

if (sortableList) {
    const items = sortableList.querySelectorAll('.story-thing-item');
    
    items.forEach(item => {
        item.draggable = true;
        
        item.addEventListener('dragstart', function(e) {
            draggedItem = this;
            this.classList.add('dragging');
        });
        
        item.addEventListener('dragend', function() {
            this.classList.remove('dragging');
        });
        
        item.addEventListener('dragover', function(e) {
            e.preventDefault();
            const afterElement = getDragAfterElement(sortableList, e.clientY);
            if (afterElement == null) {
                sortableList.appendChild(draggedItem);
            } else {
                sortableList.insertBefore(draggedItem, afterElement);
            }
        });
    });
}

function getDragAfterElement(container, y) {
    const draggableElements = [...container.querySelectorAll('.story-thing-item:not(.dragging)')];
    
    return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        
        if (offset < 0 && offset > closest.offset) {
            return { offset: offset, element: child };
        } else {
            return closest;
        }
    }, { offset: Number.NEGATIVE_INFINITY }).element;
}

function removeThing(storyThingId) {
    if (confirm('Remove this thing from the story?')) {
        const form = document.getElementById('story-form');
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'remove_thing';
        input.value = storyThingId;
        form.appendChild(input);
        form.submit();
    }
}

// Update hidden inputs when order changes
document.getElementById('story-form').addEventListener('submit', function(e) {
    if (e.submitter && e.submitter.name === 'reorder') {
        // Clear existing order inputs
        const existingInputs = document.querySelectorAll('input[name="thing_order"]');
        existingInputs.forEach(input => input.remove());
        
        // Add new order inputs
        const items = sortableList.querySelectorAll('.story-thing-item');
        items.forEach((item, index) => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'thing_order';
            input.value = item.dataset.id;
            this.appendChild(input);
            
            // Also save duration values
            const durationInput = item.querySelector('.duration-input');
            if (durationInput) {
                const durInput = document.createElement('input');
                durInput.type = 'hidden';
                durInput.name = `duration_${item.dataset.id}`;
                durInput.value = durationInput.value;
                this.appendChild(durInput);
            }
        });
    }
});
</script>
{% endblock %}